<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulador</title>

<style>
body{
  font-family:Arial;
  padding:15px;
  background:#f4f4f4;
}

h2{margin:0;}

.topo{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

button{
  padding:8px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

.small-btn{
  font-size:12px;
  padding:5px 8px;
}

.botoes-topo{
  display:flex;
  gap:8px;
  margin:10px 0;
}

#modoBtn,#txespecBtn{
  flex:1;
}

#valor{
  width:100%;
  padding:12px;
  font-size:18px;
  margin-bottom:10px;
  border-radius:6px;
  border:1px solid #ccc;
}

.parcela{
  padding:6px;
  margin:4px 0;
  border-radius:6px;
  background:#fff;
}

.destaque{
  background:#d4edda;
  font-weight:bold;
}

.opaca{
  opacity:0.4;
}

#produtosPagina{
  display:none;
}

.produto-item{
  background:#fff;
  padding:10px;
  margin:8px 0;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="topo">
  <h2>Simulador</h2>
  <button onclick="limparCache()" class="small-btn">Limpar</button>
</div>

<div id="principal">

  <div class="botoes-topo">
    <button id="modoBtn">Card</button>
    <button id="txespecBtn">Tx Especial</button>
  </div>

  <input 
    type="text"
    id="valor"
    placeholder="R$ 0,00"
    inputmode="numeric"
    pattern="[0-9]*"
    autocomplete="off"
    enterkeyhint="done"
  />

  <button onclick="abrirProdutos()">Produtos</button>

  <div id="resultado"></div>
  <button id="verTodas" style="display:none;">Ver todas parcelas</button>

</div>

<div id="produtosPagina">
  <h3>Produtos</h3>
  <div id="listaProdutos"></div>
  <button onclick="fecharProdutos()">Voltar</button>
</div>

<script src="taxas.js"></script>
<script src="produtos.js"></script>

<script>

let modoSimulacao="cartao";
let txEspecialAtiva=false;
let mostrarTodas=false;

const input=document.getElementById("valor");
const resultado=document.getElementById("resultado");
const modoBtn=document.getElementById("modoBtn");
const txBtn=document.getElementById("txespecBtn");
const verTodasBtn=document.getElementById("verTodas");

input.addEventListener("input",formatarMoeda);

modoBtn.addEventListener("click",()=>{
  if(modoSimulacao==="cartao"){
    modoSimulacao="consignado";
    modoBtn.textContent="Consignado";
    txBtn.style.display="none";
  }else{
    modoSimulacao="cartao";
    modoBtn.textContent="Card";
    txBtn.style.display="block";
  }
  calcularAtual();
});

txBtn.addEventListener("click",()=>{
  txEspecialAtiva=!txEspecialAtiva;
  txBtn.style.background=txEspecialAtiva?"#28a745":"";
  calcularAtual();
});

verTodasBtn.addEventListener("click",()=>{
  mostrarTodas=!mostrarTodas;
  verTodasBtn.textContent=mostrarTodas?"Mostrar menos":"Ver todas parcelas";
  calcularAtual();
});

function formatarMoeda(){
  let valor=limparNumero(input.value);
  if(!valor){
    resultado.innerHTML="";
    return;
  }
  input.value=valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  calcular(valor);
}

function limparNumero(v){
  return Number(v.replace(/\D/g,""))/100;
}

function calcularAtual(){
  let valor=limparNumero(input.value);
  if(valor) calcular(valor);
}

function calcular(valor){

  resultado.innerHTML="";

  if(modoSimulacao==="cartao"){

    for(let i=0;i<18;i++){

      if(!mostrarTodas && i>=12) continue;

      let parcela;

      if(txEspecialAtiva && i < 3){
        parcela = valor / (i+1);
      }else{
        parcela = (valor * (1 + TAXAS_CARTAO[i])) / (i+1);
      }

      let div=document.createElement("div");
      div.className="parcela";

      if(i<3) div.classList.add("destaque");
      if(i>=12) div.classList.add("opaca");

      div.textContent=`${i+1}x de ${parcela.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`;

      resultado.appendChild(div);
    }

    verTodasBtn.style.display="block";

  }else{

    for(let p in COEFICIENTES_CONSIGNADO){
      let parcela=valor*COEFICIENTES_CONSIGNADO[p];
      let div=document.createElement("div");
      div.className="parcela";
      div.textContent=`${p}x de ${parcela.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`;
      resultado.appendChild(div);
    }

    verTodasBtn.style.display="none";
  }
}

function abrirProdutos(){
  document.getElementById("principal").style.display="none";
  document.getElementById("produtosPagina").style.display="block";
  carregarProdutos();
}

function fecharProdutos(){
  document.getElementById("principal").style.display="block";
  document.getElementById("produtosPagina").style.display="none";
}

function carregarProdutos(){
  let lista=document.getElementById("listaProdutos");
  lista.innerHTML="";
  PRODUTOS.forEach(p=>{
    let div=document.createElement("div");
    div.className="produto-item";
    div.innerHTML=`
      <strong>${p.nome}</strong><br>
      ${p.descricao}<br>
      <strong>${p.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</strong><br>
      <button onclick="selecionarProduto(${p.valor})">Selecionar</button>
    `;
    lista.appendChild(div);
  });
}

function selecionarProduto(valor){
  fecharProdutos();
  input.value=valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  calcular(valor);
}

function limparCache(){
  localStorage.clear();
  alert("Cache limpo");
}

</script>

</body>
</html>
